---
config:
  theme: default
---
erDiagram
    direction TB
    EDIFICIO ||--|{ PLANTA : "contiene"
    PLANTA ||--|{ AREA : "contiene"
    TIPO_AREA ||--o{ AREA : "es de tipo"
    ADYACENCIA ||--|{ AREA : "tiene origen"
    ADYACENCIA ||--|{ AREA : "tiene destino"
    TIPO_ADYACENCIA ||--o{ ADYACENCIA : "es de tipo"

    UBICACION ||--|| AREA : "es"
    UBICACION ||--|| ADYACENCIA : "es"
    TIPO_UBICACION ||--o{ UBICACION : "clasifica"

    UBICACION ||--o{ BALIZA : "ubicada en"
    SENSOR ||--o{ BALIZA_SENSOR : "es parte de"
    BALIZA ||--o{ BALIZA_SENSOR : "conectada a"
    SENSOR ||--o{ SENSOR_VARIABLE : "mide"
    VARIABLE ||--o{ SENSOR_VARIABLE : "usada en"

    BALIZA ||--o{ LECTURA : "genera"
    SENSOR ||--o{ LECTURA : "usa"
    VARIABLE ||--o{ LECTURA : "mide"

    UBICACION ||--o{ LECTURA : "ocurre en"
    LECTURA ||--o{ HISTORICO_LECTURAS : "recoge"

    ESTADO_ACTUAL ||--|{ LECTURA_ESTADO : "basada en"
    LECTURA ||--o{ LECTURA_ESTADO : "asociada"
    ESTADO_ACTUAL ||--o{ HISTORICO_ESTADO : "recoge"

    EVALUACION_SEGURIDAD }|--|| TIPO_EVENTO : "tiene"
    EVALUACION_SEGURIDAD ||--o{ ESTADO_ACTUAL : "deriva de"
    EVALUACION_SEGURIDAD ||--o{ HISTORICO_EVALUACION_SEGURIDAD : "recoge"
    UBICACION||--|| EVALUACION_SEGURIDAD : "evaluada en"

    RUTA }|--|{ EVALUACION_SEGURIDAD : "usa"
    RUTA ||--o{ UBICACION : "es origen de"
    RUTA ||--o{ HISTORICO_RUTA : "recoge"
    
    USUARIO ||--o{ RUTA : "solicita"
    USUARIO ||--o{ USUARIO_UBICACION_ACTUAL : "tiene"
    USUARIO_UBICACION_ACTUAL ||--o{ HISTORICO_USUARIO_UBICACION : "tuvo"

    UBICACION ||--o{ USUARIO_UBICACION_ACTUAL : "usuario en"

    EDIFICIO {
      int id_edificio PK
      varchar nombre
      text descripcion
      float latitud
      float longitud
      int capacidad_personas
      float superficie_metros_cuadrados
    }
    PLANTA {
      int id_planta PK
      float superficie_metros_cuadrados
      int id_edificio FK
    }
    AREA {
      int id_area PK
      int id_ubicacion FK
      varchar nombre
      text descripcion
      float superficie_metros_cuadrados
      int capacidad_personas
      boolean salida_segura
      int id_planta FK
      int id_tipo_area FK
    }
    TIPO_AREA {
      int id_tipo_area PK
      varchar nombre
      text descripcion
    }
    ADYACENCIA {
      int id_adyacencia PK
      int id_ubicacion FK
      varchar nombre
      text descripcion
      float distancia_metros
      int capacidad_flujo_personas_minuto
      float tiempo_estimado_segundos
      boolean bidireccional
      int id_area_origen FK
      int id_area_destino FK
      int id_tipo_adyacencia FK
    }
    TIPO_ADYACENCIA {
      int id_tipo_adyacencia PK
      varchar nombre
      text descripcion
    }
    UBICACION {
      int id_ubicacion PK
      int id_tipo_ubicacion FK
    }
    TIPO_UBICACION {
      int id_tipo_ubicacion PK
      varchar nombre 
    }
    BALIZA {
      int id_baliza PK
      varchar nombre
      text descripcion
      boolean activa
      int id_ubicacion FK
    }
    SENSOR {
      int id_sensor PK 
      varchar nombre
      text descripcion
      boolean activa
    }
    VARIABLE {
      int id_variable PK
      varchar nombre
      text descripcion
      varchar unidad
    }
    BALIZA_SENSOR {
      int id PK
      int id_baliza FK
      int id_sensor FK 
      text descripcion
    }
    SENSOR_VARIABLE {
      int id PK
      int id_sensor FK
      int id_variable FK
      text descripcion
    }
    LECTURA {
      int id_lectura PK
      int id_ubicacion FK
      timestamp datetime
      int id_baliza FK
      int id_sensor FK
      int id_variable FK
      float valor
    }
    HISTORICO_LECTURAS {
      int id PK
      timestamp datetime
      int id_lectura FK
    }
    LECTURA_ESTADO {
      int id PK
      int id_lectura FK
      int id_estado_actual FK
    }
    ESTADO_ACTUAL {
      int id_estado_actual PK
      timestamp datetime 
      int id_lectura FK
    }
    HISTORICO_ESTADO {
      int id PK
      timestamp datetime
      int id_estado_actual FK
    }
    EVALUACION_SEGURIDAD {
      int id_seguridad PK
      timestamp datetime 
      float valor_seguridad
      boolean requiere_evacuar
      text descripcion
      int id_estado_actual FK
      int id_evento FK
      int id_ubicacion FK
    }
    HISTORICO_EVALUACION_SEGURIDAD {
      int id PK
      timestamp datetime
      int id_seguridad FK
    }
    TIPO_EVENTO {
      int id_evento PK
      varchar nombre
      boolean requiere_evacuar
      VARCHAR tipo_de_evento
    }
    USUARIO {
        int id_usuario PK
        varchar nombre
        varchar correo
        timestamp creado_en
    }
    USUARIO_UBICACION_ACTUAL {
        int id_ubicacion_usuario PK
        int id_usuario FK
        int id_ubicacion FK
        timestamp fecha
    }
    HISTORICO_USUARIO_UBICACION {
        int id PK
        int id_usuario FK
        int id_ubicacion FK
        timestamp deteccion
    }
    RUTA {
      int id_ruta PK
      int id_ubicacion_origen FK
      timestamp fecha
      int tiempo_estimado_total
      jsonb ruta
      int id_seguridad FK
      int id_usuario FK
    }
    HISTORICO_RUTA {
      int id PK
      int id_ruta FK
      timestamp datetime
    }